















<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="last-modified" content="2019-08-07 15:59:42 -0500">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- meta "search-domain" used for google site search function google_search() -->
    <meta name="search-domain" value="">
    <link rel="stylesheet" type="text/css" href="../assets/css/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="../assets/css/bootstrap-theme.css" />
    <link rel="stylesheet" type="text/css" href="../assets/css/lesson.css" />
    <link rel="stylesheet" type="text/css" href="../assets/css/syntax.css" />

    



    <!-- Favicons for everyone -->
    <link rel="apple-touch-icon-precomposed" sizes="57x57" href="../assets/favicons/swc/apple-touch-icon-57x57.png" />
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/favicons/swc/apple-touch-icon-114x114.png" />
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/favicons/swc/apple-touch-icon-72x72.png" />
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/favicons/swc/apple-touch-icon-144x144.png" />
    <link rel="apple-touch-icon-precomposed" sizes="60x60" href="../assets/favicons/swc/apple-touch-icon-60x60.png" />
    <link rel="apple-touch-icon-precomposed" sizes="120x120" href="../assets/favicons/swc/apple-touch-icon-120x120.png" />
    <link rel="apple-touch-icon-precomposed" sizes="76x76" href="../assets/favicons/swc/apple-touch-icon-76x76.png" />
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../assets/favicons/swc/apple-touch-icon-152x152.png" />
    <link rel="icon" type="image/png" href="../assets/favicons/swc/favicon-196x196.png" sizes="196x196" />
    <link rel="icon" type="image/png" href="../assets/favicons/swc/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/png" href="../assets/favicons/swc/favicon-32x32.png" sizes="32x32" />
    <link rel="icon" type="image/png" href="../assets/favicons/swc/favicon-16x16.png" sizes="16x16" />
    <link rel="icon" type="image/png" href="../assets/favicons/swc/favicon-128.png" sizes="128x128" />
    <meta name="application-name" content="Software Carpentry - Network Security"/>
    <meta name="msapplication-TileColor" content="#FFFFFF" />
    <meta name="msapplication-TileImage" content="../assets/favicons/swc/mstile-144x144.png" />
    <meta name="msapplication-square70x70logo" content="../assets/favicons/swc/mstile-70x70.png" />
    <meta name="msapplication-square150x150logo" content="../assets/favicons/swc/mstile-150x150.png" />
    <meta name="msapplication-wide310x150logo" content="../assets/favicons/swc/mstile-310x150.png" />
    <meta name="msapplication-square310x310logo" content="../assets/favicons/swc/mstile-310x310.png" />


    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
	<script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
	<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
	<![endif]-->
    <title>Network Security: Public Key Infrastructure Lab</title>
  </head>
  <body>

    


<div class="panel panel-default life-cycle">
  <div id="life-cycle" class="panel-body pre-alpha">
    This lesson is still being designed and assembled (Pre-Alpha version)
  </div>
</div>





    <div class="container">
      






<nav class="navbar navbar-default">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      
      
      <a href="https://software-carpentry.org" class="pull-left">
        <img class="navbar-logo" src="../assets/img/swc-icon-blue.svg" alt="Software Carpentry logo" />
      </a>
      

      
      <a class="navbar-brand" href="../index.html">Home</a>

    </div>
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">

	
        <li><a href="../CODE_OF_CONDUCT.html">Code of Conduct</a></li>

        
	
        <li><a href="../setup.html">Setup</a></li>

        
        <li class="dropdown">
          <a href="../" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Episodes <span class="caret"></span></a>
          <ul class="dropdown-menu">
            
            <li><a href="../01-passwordcracking/index.html">Password Hashing and Cracking</a></li>
            
            <li><a href="../02-rsa/index.html">RSA Public-Key Encryption and Signature Lab</a></li>
            
            <li><a href="../03-pki/index.html">Public Key Infrastructure Lab</a></li>
            
	    <li role="separator" class="divider"></li>
            <li><a href="../aio.html">All in one page (Beta)</a></li>
          </ul>
        </li>
	

	
	
        <li class="dropdown">
          <a href="../" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Extras <span class="caret"></span></a>
          <ul class="dropdown-menu">
            <li><a href="../reference.html">Reference</a></li>
            
            <li><a href="../about/index.html">About</a></li>
            
            <li><a href="../discuss/index.html">Discussion</a></li>
            
            <li><a href="../figures/index.html">Figures</a></li>
            
            <li><a href="../guide/index.html">Instructor Notes</a></li>
            
          </ul>
        </li>
	

	
        <li><a href="../LICENSE.html">License</a></li>
	
	<li><a href="/edit//_episodes/03-pki.md">Improve this page <span class="glyphicon glyphicon-pencil" aria-hidden="true"></span></a></li>
	
      </ul>
      <form class="navbar-form navbar-right" role="search" id="search" onsubmit="google_search(); return false;">
        <div class="form-group">
          <input type="text" id="google-search" placeholder="Search..." aria-label="Google site search">
        </div>
      </form>
    </div>
  </div>
</nav>

















<div class="row">
  <div class="col-xs-1">
    <h3 class="text-left">
      
      <a href="../02-rsa/index.html"><span class="glyphicon glyphicon-menu-left" aria-hidden="true"></span><span class="sr-only">previous episode</span></a>
      
    </h3>
  </div>
  <div class="col-xs-10">
    
    <h3 class="maintitle"><a href="../">Network Security</a></h3>
    
  </div>
  <div class="col-xs-1">
    <h3 class="text-right">
      
      <a href="../"><span class="glyphicon glyphicon-menu-up" aria-hidden="true"></span><span class="sr-only">lesson home</span></a>
      
    </h3>
  </div>
</div>

<article>
<div class="row">
  <div class="col-md-1">
  </div>
  <div class="col-md-10">
    <h1 class="maintitle">Public Key Infrastructure Lab</h1>
  </div>
  <div class="col-md-1">
  </div>
</div>


<blockquote class="objectives">
  <h2>Overview</h2>

  <div class="row">
    <div class="col-md-3">
      <strong>Teaching:</strong> 30 min
      <br/>
      <strong>Exercises:</strong> 60 min
    </div>
    <div class="col-md-9">
      <strong>Questions</strong>
      <ul>
	
	<li><p>What is Certificate Authority?</p>
</li>
	
	<li><p>How is PKI used in the web?</p>
</li>
	
	<li><p>How does HTTPS work?</p>
</li>
	
	<li><p>How do you sign certificates ?</p>
</li>
	
      </ul>
    </div>
  </div>

  <div class="row">
    <div class="col-md-3">
    </div>
    <div class="col-md-9">
      <strong>Objectives</strong>
      <ul>
	
	<li><p>Follow the instructions to become the root CA, sign certificates, and manage HTTPS websites in Apache server.</p>
</li>
	
      </ul>
    </div>
  </div>

</blockquote>

<h2 id="public-key-infrastructure-lab">Public Key Infrastructure Lab</h2>

<h3 id="acknowledgment">Acknowledgment</h3>
<p>This lab was originally designed by <a href="https://seedsecuritylabs.org/Labs_16.04/Crypto/Crypto_PKI/">SEEDLabs</a> and Dr. Wenliang Du.</p>

<h3 id="lab-overview">Lab Overview</h3>
<p>Public key cryptography is the foundation of today’s secure communication, but it is subject to man-in-the- middle attacks when one side of the communication sends its public key to the other side. The fundamental problem is that there is no easy way to verify the ownership of a public key, i.e., given a public key and its claimed owner information, how do we ensure that the public key is indeed owned by the claimed owner?<br />
The Public Key Infrastructure (PKI) is a practical solution to this problem. 
The learning objective of this lab is for students to gain the first-hand experience on PKI. By doing the tasks in this lab, students should be able to gain a better understanding of how PKI works, how PKI is used to protect the Web, and how Man-in-the-middle attacks can be defeated by PKI. Moreover, students will be able to understand the root of the trust in the public-key infrastructure, and identify the problems that will arise when the root trust is broken. This lab covers the <strong>following topics</strong>:</p>
<ul>
  <li>Public-key encryption</li>
  <li>Public-Key Infrastructure (PKI)</li>
  <li>Certificate Authority (CA) and root CA</li>
  <li>X.509 certificate and self-signed certificate</li>
  <li>Apache, HTTP, and HTTPS</li>
  <li>Man-in-the-middle attacks</li>
</ul>

<h3 id="lab-tasks">Lab Tasks</h3>
<h4 id="task1-becoming-a-certificate-authority-ca">Task1: Becoming a Certificate Authority (CA)</h4>
<p>A Certificate Authority (CA) is a trusted entity that issues digital certificates. The digital certificate certifies the ownership of a public key by the named subject of the certificate. In this lab, we need to create digital certificates, but we are not going to pay any commercial CA. We will become a root CA ourselves and then use this CA to issue certificate for others. Unlike other certificates, which are usually signed by another CA, the root CA’s certificates are self-signed. Root CA’s certificates are usually pre-loaded into most operating systems, web browsers, and other software that rely on PKI. Root CA’s certificates are unconditionally trusted.</p>
<h4 id="the-configuration-file-opensslcnf">The configuration file (openssl.cnf)</h4>
<p>In order to use OpenSSL to create certificates, you have to have a configuration file. The configuration file usually has an extension .cnf. It is used by three OpenSSL commands: ca, req and x509. The configuration file is located in <strong>/usr/lib/ssl/openssl.cnf</strong> however, openssl.cnf has already been copied to <strong>/home/user/demoCA/openssl.cnf</strong> in the container. Openssl requires the following sub-directories however, the configuration has already been completed in the container.</p>
<pre><code class="language-source">dir             = ./demoCA        # Where everything is kept
certs           = $dir/certs      # Where the issued certs are kept
crl_dir	        = $dir/crl        # Where the issued crl are kept
new_certs_dir   = $dir/newcerts   # default place for new certs.
database        = $dir/index.txt  # database index file.
serial          = $dir/serial     # The current serial number
</code></pre>
<p>For the index.txt file, an empty file has been created. For the serial file, a single number in string format (e.g. 1000) has been entered in the file.</p>
<blockquote class="callout">
  <h2 id="openssl-configuration">Openssl Configuration</h2>
  <p>The required directories are configured under <strong>demoCA</strong> directory, which is located under 
<strong>/home/user</strong> directory.<br />
In order to understand how openssl is configured, please take a look at <strong>demoCA</strong> directory and compare them to
openssl.cnf file.</p>
</blockquote>

<h4 id="certificate-authority-ca">Certificate Authority (CA)</h4>
<p>As we described before, we need to generate a self-signed certificate for our CA. This means that this CA is totally trusted, and its certificate will serve as the root certificate.<br />
Run the following command in the <strong>demoCA</strong> directory to generate a self-signed certificate for the CA:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openssl req <span class="nt">-new</span> <span class="nt">-x509</span> <span class="nt">-keyout</span> ca.key <span class="nt">-out</span> ca.crt <span class="nt">-config</span> openssl.cnf
</code></pre></div></div>
<p>You will be prompted for information and a password. <strong>Do not lose this password</strong>, because you will have to type the passphrase each time you want to use this CA to sign certificates for others. You will also be asked to fill in some information, such as the Country Name, Common Name, etc. The output of the command are stored in two files: <strong>ca.key</strong> and <strong>ca.crt</strong>. The file <strong>ca.key</strong> contains the CA’s <strong>private key</strong>, while <strong>ca.crt</strong> contains the <strong>public-key certificate</strong>.</p>

<h4 id="task2-creating-a-certificate-for-seedpkilab2018com">Task2: Creating a Certificate for SEEDPKILab2018.com</h4>
<p>Now that we have become a root CA, we are ready to sign digital certificates for our customers. Our first customer is a company called SEEDPKILab2018.com. In order for this company to get a digital certificate from a CA, it needs to go through three steps.</p>
<h5 id="step-1-generate-publicprivate-key-pair">Step 1: Generate public/private key pair</h5>
<p>The company needs to first create its own public/private key pair. We can run the following command to generate an RSA key pair (both private and public keys). You will also be required to provide a password to encrypt the private key (using the AES-128 encryption algorithm, as is specified in the command option). The keys will be stored in the file server.key:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openssl genrsa <span class="nt">-aes128</span> <span class="nt">-out</span> server.key 1024
</code></pre></div></div>
<p>The server.key is an encoded text file (also encrypted), so you will not be able to see the actual
content, such as the modulus, private exponents, etc. To see those, you can run the following command:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openssl rsa <span class="nt">-in</span> server.key <span class="nt">-text</span>
</code></pre></div></div>
<h5 id="step-2-generate-a-certificate-signing-request-csr">Step 2: Generate a Certificate Signing Request (CSR)</h5>
<p>Once the company has the key file, it should generates a Certificate Signing Request (CSR), which basically includes the company’s public key. The CSR will be sent to the CA, who will generate a certificate for the key (usually after ensuring that identity information in the CSR matches with the server’s true identity). Please use <strong>SEEDPKILab2018.com</strong> as the common name of the certificate request.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openssl req <span class="nt">-new</span> <span class="nt">-key</span> server.key <span class="nt">-out</span> server.csr <span class="nt">-config</span> openssl.cnf
</code></pre></div></div>
<p>It should be noted that the above command is quite similar to the one we used in creating the self-signed certificate for the CA. The only difference is the <em>-x509</em> option. Without it, the command generates a request; with it, the command generates a self-signed certificate.</p>

<h5 id="step-3-generating-certificates">Step 3: Generating Certificates</h5>
<p>The CSR file needs to have the CA’s signature to form a certificate. In the real world, the CSR files are usually sent to a trusted CA for their signature. In this lab, we will use our own trusted CA to generate certificates. The following command turns the certificate signing request (<strong>server.csr</strong>) into an X509 certificate (<strong>server.crt</strong>), using the CA’s <strong>ca.crt</strong> and <strong>ca.key</strong>:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openssl ca <span class="nt">-in</span> server.csr <span class="nt">-out</span> server.crt <span class="nt">-cert</span> ca.crt <span class="nt">-keyfile</span> ca.key <span class="nt">-config</span> openssl.cnf
</code></pre></div></div>

<p>If OpenSSL refuses to generate certificates, it is very likely that the names in your requests do not match with those of CA. The matching rules are specified in the configuration file ( In <strong>openssl.cnf</strong> look at the [policy match] section). You can change the names of your requests to comply with the policy, or you can change the policy. The configuration file also includes another policy (called <strong>policy anything</strong>), which is less restrictive. You can choose that policy by changing the following line: (<strong>vim</strong> is available in the container).</p>
<div class="source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>"policy = policy_match"  change to "policy = policy_anything".
</code></pre></div></div>

<h4 id="task3-deploying-certificate-in-an-https-web-server">Task3: Deploying Certificate in an HTTPS Web Server</h4>
<p>In this task, we will explore how public-key certificates are used by websites to secure web browsing. We will set up an HTTPS website using openssl’s built-in web server.</p>
<h5 id="step-1-configuring-dns">Step 1: Configuring DNS</h5>
<p>We choose <strong>SEEDPKILab2018.com</strong> as the name of our website. To get our computers recognize this name, let us add the following entry to /etc/hosts; this entry basically maps the hostname SEEDPKILab2018.com to our localhost (i.e., <strong>127.0.0.1</strong>):<br />
Edit the /etc/hosts file by typing in the following command.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>vim /etc/hosts
</code></pre></div></div>
<p>Add the following entries to the /etc/hosts file.</p>

<pre><code class="language-source">127.0.0.1  SEEDPKILab2018.com
</code></pre>
<h5 id="step-2-configuring-the-web-server">Step 2: Configuring the web server</h5>
<p>Let us launch a simple web server with the certificate generated in the previous task. OpenSSL allows us to start a simple web server using the <strong><em>s_server</em></strong> command:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Combine the secret key and certificate into one file</span>
<span class="nb">cp </span>server.key server.pem
<span class="nb">cat </span>server.crt <span class="o">&gt;&gt;</span> server.pem
<span class="c"># Launch the web server using server.pem</span>
openssl s_server <span class="nt">-cert</span> server.pem <span class="nt">-www</span>
</code></pre></div></div>

<p>By default, the server will listen on port <strong>4433</strong>. You can alter that using the <strong><em>-accept</em></strong> option. Now, you can access the server using the following URL.</p>
<pre><code class="language-source">https://SEEDPKILab2018.com:4433
</code></pre>
<p>Most likely, you will get an error message from the browser. In Firefox, you will see a message like the following:</p>

<pre><code class="language-source">seedpkilab2018.com:4433 uses an invalid security certificate. The certificate is not trusted because the issuer certificate is unknown
</code></pre>

<h5 id="step-3-getting-the-browser-to-accept-our-ca-certificate">Step 3: Getting the browser to accept our CA certificate</h5>
<p>Had our certificate been assigned by VeriSign, we will not have such an error message because VeriSign’s certificate is very likely preloaded into Firefox’s certificate repository. Unfortunately, the certificate of SEEDPKILab2018.com is signed by our own CA (i.e., using ca.crt), and this CA is not recognized by Firefox. There are two ways to get Firefox to accept our CA’s self-signed certificate.</p>
<ul>
  <li>We can request Mozilla to include our CA’s certificate in its Firefox software, so everybody using Firefox can recognize our CA. This is how the real CAs, such as VeriSign, get their certificates into Firefox. Unfortunately, our own CA does not have a large enough market for Mozilla to include our certificate, so we will not pursue this direction.</li>
  <li>Load <strong>ca.crt</strong> into Firefox: We can manually add our CA’s certificate to the Firefox browser by clicking the following menu sequence:</li>
</ul>

<pre><code class="language-source">Edit -&gt; Preference -&gt; Privacy &amp; Security -&gt; View Certificates
</code></pre>
<p>You will see a list of certificates that are already accepted by Firefox. From here, we can “import” our own certificate.<br />
Please import <strong>ca.crt</strong>, and select the following option:</p>
<pre><code class="language-source">Trust this CA to identify web sites. 
</code></pre>
<p>You will see that our CA’s certificate is now in Firefox’s list of the accepted certificates.</p>

<h5 id="step-4-testing-our-https-website">Step 4: Testing our HTTPS website</h5>
<p>Now, point the browser to <strong>https://SEEDPKILab2018.com: 4433</strong>. 
Please also do the following tasks:</p>
<ul>
  <li>Modify a single byte of server.pem, restart the server, and reload the URL. What do you observe? Make sure you restore the original server.pem afterward. <em>Note: the server may not be able to restart if certain places of server.pem is corrupted; in that case, choose another place to modify.</em></li>
  <li>Since SEEDPKILab2018.com points to the localhost, if we use <strong><em>https://localhost:4433</em></strong> instead, we will be connecting to the same web server.</li>
</ul>

<h4 id="task-4-deploying-certificate-in-an-apache-based-https-website">Task 4: Deploying Certificate in an Apache-Based HTTPS Website</h4>
<p>The HTTPS server setup using openssl’s <em>s_server</em> command is primarily for debugging and demonstration purposes. In this task, we will set up a real HTTPS web server based on Apache. The Apache server, which is already installed in our container, supports the HTTPS protocol. To create an HTTPS website, we just need to configure the Apache server, so it knows where to get the private key and certificates. We give an example in the following to show how to enable HTTPS for a website <strong><em>www.example.com</em></strong>. <br />
Your task is to do the same for SEEDPKILab2018.com using the certificate generated from previous tasks.
An Apache server can simultaneously host multiple websites. An Apache server can simultaneously host multiple websites. It needs to know the directory where website’s files are stored. This is done via its VirtualHost file, located in the <strong>/etc/apache2/sites-available</strong> directory.<br />
To add an HTTP website, we add a VirtualHost entry to the file <strong>000-default.conf</strong>. See the following example.</p>
<div class="source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;VirtualHost *:80&gt;
    ServerName one.example.com
    DocumentRoot /var/www/Example_One
    DirectoryIndex index.html
&lt;/VirtualHost&gt;
</code></pre></div></div>
<p>To add an HTTPS website, we need to add a VirtualHost entry to the default-ssl.conf file in the same folder.
You will be able to modify the default-ssl.conf file by typing in:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>vim /etc/apache2/sites-available/default-ssl.conf
</code></pre></div></div>
<div class="source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;VirtualHost *:443&gt;
    	ServerName two.example.com
    	DocumentRoot /var/www/Example_Two
	DirectoryIndex index.html
	SSLEngine On
	SSLCertificateFile /etc/apache2/ssl/example_cert.pem 􏰀 
	SSLCertificateKeyFile /etc/apache2/ssl/example_key.pem 􏰁
&lt;/VirtualHost&gt;
</code></pre></div></div>
<p>The <strong>ServerName</strong> entry specifies the name of the website, while the DocumentRoot entry specifies where the files for the website are stored. The above example sets up the HTTPS site <strong>https://two. example.com</strong> (<strong>port 443</strong> is the default HTTPS port). <br />
In the setup, we need to tell Apache where the server certificate (<strong>SSLCertificateFile</strong>) and private key (<strong>SSLCertificateKeyFile</strong>􏰁) are stored.<br />
After the default-ssl.conf file is modified, we need to run a series of commands to enable SSL. Apache will ask us to type the password used for encrypting the private key. Once everything is set up properly, we can browse the web site, and all the traffic between the browser and the server will be encrypted.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Start the Apache server</span>
<span class="nb">sudo </span>service apache2 start 
<span class="c"># Test the Apache configuration file for errors</span>
<span class="nb">sudo </span>apachectl configtest
<span class="c"># Enable the SSL module</span>
<span class="nb">sudo </span>a2enmod ssl
<span class="c"># Enable the site we have just edited</span>
<span class="nb">sudo </span>a2ensite default-ssl
<span class="c"># Restart Apache</span>
<span class="nb">sudo </span>service apache2 restart
</code></pre></div></div>
<p>Please use the above example as guidance to set up an HTTPS server for <strong>SEEDPKILab2018.com</strong>.</p>
<blockquote class="callout">
  <h2 id="apache-https-configuration">Apache HTTPS Configuration</h2>
  <p>A HTML file named <strong>index.html</strong> has already been placed in the directory named <strong>/var/www/crypto</strong><br />
Please use them when configuring HTTPS.</p>
</blockquote>
<h4 id="task-5-launching-a-man-in-the-middle-attack">Task 5: Launching a Man-In-The-Middle Attack</h4>
<p>In this task, we will show how PKI can defeat Man-In-The-Middle (MITM) attacks. The following figure depicts how MITM attacks work. 
<img src="../fig/pki/MITM.png" alt="mitm" />
Assume Alice wants to visit example.com via the HTTPS protocol. She needs to get the public key from the example.com server; Alice will generate a secret, and encrypt the secret using the server’s public key, and send it to the server. If an attacker can intercept the communication between Alice and the server, the attacker can replace the server’s public key with its own public key. Therefore, Alice’s secret is actually encrypted with the attacker’s public key, so the attacker will be able to read the secret. The attacker can forward the secret to the server using the server’s public key. The secret is used to encrypt the communication between Alice and server, so the attacker can decrypt the encrypted communication.<br />
The goal of this task is to help students understand how PKI can defeat such MITM attacks. In the task, we will emulate an MITM attack, and see how exactly PKI can defeat it. We will select a target website first. In this document, we use <strong>example.com</strong> as the target website.</p>

<h5 id="step-1-setting-up-the-malicious-website">Step 1: Setting up the malicious website</h5>
<p>In Task 4, we have already set up an HTTPS website for SEEDPKILab2018.com. We will use the same Apache server to impersonate example.com. To achieve that, we will follow the instruction in Task 4 to add a VirtualHost entry to Apache’s SSL configuration file: the ServerName should be example.com, but the rest of the configuration can be the same as those used in Task 4. Our goal is the following: when a user tries to visit example.com, we are going to get the user to land in our server, which hosts a fake website for example.com. If this were a social network website, the fake site can display a login page similar to the one in the target website. If the users cannot tell the difference, they may type their account credentials in the fake webpage; essentially disclosing the credentials to the attacker.</p>

<h5 id="step-2-becoming-the-man-in-the-middle">Step 2: Becoming the man in the middle</h5>
<p>There are several ways to get the user’s HTTPS request to land in our web server. One way is to attack the routing, so the user’s HTTPS request is routed to our web server. Another way is to attack DNS, so when the victim’s machine tries to find out the IP address of the target web server, it gets the IP address of our web server. In this task, we will attack the DNS by modifying the <strong>/etc/hosts</strong> file.</p>
<pre><code class="language-source">&lt;IP_Address&gt;  example.com
</code></pre>
<h5 id="step-3-browse-the-target-website">Step 3: Browse the target website</h5>
<p>With everything set up, now visit the target real website, and see what your browser would say.</p>

<h4 id="task-6-launching-a-man-in-the-middle-attack-with-a-compromised-ca">Task 6: Launching a Man-In-The-Middle Attack with a Compromised CA</h4>
<p>Unfortunately, the root CA that we created in Task 1 is compromised by an attacker, and its private key is stolen. Therefore, the attacker can generate any arbitrary certificate using this CA’s private key. In this task, we will see the consequence of such a compromise. Please design an experiment to show that the attacker can successfully launch MITM attacks on any HTTPS website. You can use the same setting created in Task 5, but this time, you need to demonstrate that the MITM attack is successful, i.e., the browser will not raise any suspicion when the victim tries to visit a website but land in the MITM attacker’s fake website. <br />
<strong><em>Hint: you will need to create a certificate for example.com using the CA’s private/public key (The CA is compromised).</em></strong></p>



<blockquote class="keypoints">
  <h2>Key Points</h2>
  <ul>
    
    <li><p>OpenSSL and Apache web server has already been installed in the container.</p>
</li>
    
    <li><p>All of the sudo command needs to be launched from the user’s home directory!!</p>
</li>
    
    <li><p>User will be able to edit files using vim.</p>
</li>
    
  </ul>
</blockquote>

</article>
















<div class="row">
  <div class="col-xs-1">
    <h3 class="text-left">
      
      <a href="../02-rsa/index.html"><span class="glyphicon glyphicon-menu-left" aria-hidden="true"></span><span class="sr-only">previous episode</span></a>
      
    </h3>
  </div>
  <div class="col-xs-10">
    
  </div>
  <div class="col-xs-1">
    <h3 class="text-right">
      
      <a href="../"><span class="glyphicon glyphicon-menu-up" aria-hidden="true"></span><span class="sr-only">lesson home</span></a>
      
    </h3>
  </div>
</div>


      
      






<footer>
  <div class="row">
    <div class="col-md-6 copyright" align="left">
	
	Licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC-BY 4.0</a> 2018–2019
	by <a href="https://carpentries.org/">The Carpentries</a>
        <br>
        Licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC-BY 4.0</a> 2016–2018
	by <a href="https://software-carpentry.org">Software Carpentry Foundation</a>
	
    </div>
    <div class="col-md-6 help-links" align="right">
	
	<a href="/edit//_episodes/03-pki.md">Edit on GitHub</a>
	
	/
	<a href="/blob//CONTRIBUTING.md">Contributing</a>
	/
	<a href="/">Source</a>
	/
	<a href="/blob//CITATION">Cite</a>
	/
	<a href="mailto:rkalyanapurdue@gmail.com">Contact</a>
    </div>
  </div>
  <div class="row">
    <div class="col-md-12" align="center">
      Using <a href="https://github.com/carpentries/styles/">The Carpentries style</a>
      version <a href="https://github.com/carpentries/styles/releases/tag/v9.5.3">9.5.3</a>.
    </div>
  </div>
</footer>

      
    </div>
    
<script src="../assets/js/jquery.min.js"></script>
<script src="../assets/js/bootstrap.min.js"></script>
<script src="../assets/js/lesson.js"></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-37305346-2', 'auto');
  ga('send', 'pageview');
</script>

  </body>
</html>
